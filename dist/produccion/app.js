$.ajaxSettings.cache=!1;var App=function(a){var e=this;return e.appname=a.appname,e.debug=a.debug,e.store=a.store,e.rutas=a.rutas,e.loader=a.loader||"loader",e.url=a.url||{},e.pre=a.pre||function(){},e.carga=a.carga||["vistas","esquemas","catalogos"],e.carga.forEach(function(o){e[o]=a[o]||{}}),e.init(e),this};App.prototype.consola=function(a,e){if(this.debug)switch(e){case"debug":return void 0;case"error":return void 0;case"info":return void 0;default:return void 0}},App.prototype.init=function(a){app=this,app.consola("Inicializando App","debug");var e,o=0,r=function(r,i,l){app.consola("========== Cargando "+r+" ==========","debug");{var c=Object.keys(i);$("#"+a.loader+" .txt")}c.forEach(function(r){var c=i[r],d=c.match(/{\w+}/g);null!==d&&d.forEach(function(e){var o=e.replace("{","");o=o.replace("}",""),c=c.replace(e,a.url[o])}),app.consola("Cargando "+r+"- desde "+c,"debug"),$.ajax(c).done(function(c){o++;var d=parseInt(o/e*100);$("#"+a.loader+" .porcentaje").html(d+"%"),$("#"+a.loader+" .progress .progress-bar").animate({width:d+"%"},50),i[r]=c,100===d&&(app.consola("========== Finalizando la carga de elementos ==========","debug"),l===!0?t():n())}).fail(function(){app.consola(this,"error"),app.consola("Error al cargar "+this.url,"error"),$("#"+a.loader+" .txt").html("Problema cargando... Reintentando..."),$("#"+a.loader+" .porcentaje").html(""),setTimeout(function(){location.reload()},1e4)})})},t=function(){app.consola("Almacenando datos en localStorage","debug");var e={};a.carga.forEach(function(o){e[o]=a[o]}),localStorage.setItem("clientvoxData",JSON.stringify(e)),n()},n=function(){$(document).ready(function(){$("#"+a.loader).remove(),Backbone.history.start()})},i=!1;"undefined"!=typeof a.store&&a.store&&(i=!0,"undefined"==typeof Storage&&(app.consola("Se ha activado la bandera del local storage, sin embargo el navegador actual no tiene sorporte","error"),i=!1)),i?"undefined"==typeof localStorage.clientvoxData?(e=a.carga.map(function(e){return Object.keys(a[e]).length}).reduce(function(a,e){return e+a},0),app.consola("Total de elementos a cargar: "+e,"debug"),a.carga.forEach(function(e){r(e,a[e],!0)})):($.extend(a,JSON.parse(localStorage.clientvoxData)),n()):(e=a.carga.map(function(e){return Object.keys(a[e]).length}).reduce(function(a,e){return e+a},0),app.consola("Total de elementos a cargar: "+e,"debug"),a.carga.forEach(function(e){r(e,a[e],!1)})),$("body").on("updateStore",function(){localStorage.removeItem("clientvoxData"),window.location.replace(a.url.app)})},App.prototype.render=function(a){def={destino:!1,vista:!1,datos:!1,posicion:!1,urlSource:!1,vistaInline:!1,callback:!1,onError:!1};var e,o,r=this,t=$.extend({},this.def,a);if(!(t.destino instanceof jQuery))return myApp.consola("El elemento {destino} debe ser un elemento Jquery ej. $('#div')","error"),!1;if(t.destino&&t.vista)myApp.consola("La plantilla renderizada esta en memoria"),t.urlSource?this.sender.init({action:t.urlSource,ajax:!0,callback:function(a){var e=loadHTML(t.vista,a);putHTML(t.destino,e,t.posicion),r.afterRender(t.destino),t.callback&&t.callback(a)},callbackError:function(){myApp.consola("Ha ocurrido un error al realizar la petici贸n a: "+t.urlSource,"error"),t.onError&&t.onError(xhr)}}):(e=t.datos?t.datos:{},o=loadHTML(t.vista,e),putHTML(t.destino,o,t.posicion),r.afterRender(t.destino),t.callback&&t.callback(e));else if(t.destino&&t.vistaInline)if(myApp.consola("La plantilla renderizada esta dentro del HTML"),t.urlSource)this.sender.init({action:t.urlSource,ajax:!0,callback:function(a){var e=$(t.vistaInline).html(),o=loadHTML(e,a);putHTML(t.destino,o,t.posicion),r.afterRender(t.destino),t.callback&&t.callback(a)},callbackError:function(){myApp.consola("Ha ocurrido un error al realizar la petici贸n a: "+t.urlSource,"error"),t.onError&&t.onError(xhr)}});else{e=t.datos?t.datos:{};var n=$(t.vistaInline).html();o=loadHTML(n,e),putHTML(t.destino,o,t.posicion),r.afterRender(t.destino),t.callback&&t.callback(e)}else t.urlSource&&t.callback?(myApp.consola("El div escuchado solo tiene una petici贸n y un callback"),this.sender.init({action:t.urlSource,ajax:!0,callback:function(a){t.callback&&t.callback(a)},callbackError:function(){myApp.consola("Ha ocurrido un error al realizar la petici贸n a: "+t.urlSource,"error"),t.onError&&t.onError(xhr)}})):(myApp.consola("Solo buscara plantillas dentro del div"),myApp.consola("No hay plantilla a renderizar"),r.afterRender(t.destino))},App.prototype.afterRender=function(div){myApp.consola("Entra a un subtemplate");var app=this,titulo=div.children().data("title");document.title=myApp.appname+" - "+(isDefined(titulo)?titulo:"Inicio"),div.find(".form-validate").length&&div.find(".form-validate").each(function(){var a=$(this);a.parsley(),app.sender.init(a)}),div.find(".data-tbl").length&&div.find(".data-tbl").each(function(){generaTabla($(this))}),div.find(".render-tpl").length&&(myApp.consola("Evisten subplantillas","debug"),div.find(".render-tpl").each(function(){var divDom=$(this),tpl={destino:divDom,vista:isDefined(divDom.attr("vista"))?eval(divDom.attr("vista")):!1,posicion:isDefined(divDom.attr("posicion"))?divDom.attr("posicion"):!1,urlSource:isDefined(divDom.attr("urlSource"))?divDom.attr("urlSource"):!1,vistaInline:isDefined(divDom.attr("vistaInline"))?divDom.attr("vistaInline"):!1,callback:isDefined(divDom.attr("callback"))?eval(divDom.attr("callback")):!1,onError:isDefined(divDom.attr("callback"))?eval(divDom.attr("onError")):!1};app.render(tpl)}))},App.prototype.sender={"default":{attr:{},key:!1,backbone:!1,model:!1,ajax:!1,serialize:!1,serializeJson:!1,method:"get",action:!1,formData:!1,callback:!1,callbackError:!1},init:function(a){myApp.consola("inicializacion de dataSubmit","debug"),"undefined"!=typeof a?a instanceof jQuery?a.length&&this.form(a):"object"==typeof a&&this.object(a):myApp.consola("No esta definido el objeto o div para ejecutar","error")},form:function(div){myApp.consola("Seleccion de Form de dataSubmit","debug");var divDom=div,attrs=divDom.attrs();divDom.find('input[type="file"]').length>0&&isDefined(divDom.attr("backbone"))===!1&&isDefined(divDom.attr("ajax"))===!1&&(isDefined(divDom.attr("enctype"))?"multipart/form-data"!=divDom.attr("enctype")&&myApp.consola('Hay inputs tipo archivo en el form, no olvides agregar "enctype="multipart/form-data" a tu form para hacer el envio',"debug"):myApp.consola('Hay inputs tipo archivo en el form, no olvides agregar "enctype="multipart/form-data" a tu form para hacer el envio',"debug")),divDom.submit(function(){var dataSubmit={};dataSubmit.attrs=attrs,dataSubmit.callback=isDefined(divDom.attr("callback"))?eval(divDom.attr("callback")):!1,dataSubmit.callbackError=isDefined(divDom.attr("callbackError"))?eval(divDom.attr("callbackError")):!1,dataSubmit.action=isDefined(divDom.attr("action"))?divDom.attr("action"):!1,dataSubmit.key=isDefined(divDom.attr("key"))?divDom.attr("key"):!1,dataSubmit.backbone=isDefined(divDom.attr("backbone")),dataSubmit.model=isDefined(divDom.attr("model"))?isDefined(myModel[divDom.attr("model")])?divDom.attr("model"):!1:!1,dataSubmit.ajax=isDefined(divDom.attr("ajax")),dataSubmit.method=isDefined(divDom.attr("method"))?divDom.attr("method").toLowerCase():"get",dataSubmit.formData=isDefined(divDom.attr("formdata"))?divDom.serializefiles():!1,dataSubmit.serialize=isDefined(divDom.attr("serialize"))?divDom.serialize():!1,$.fn.serializeJSON?dataSubmit.serializeJson=isDefined(divDom.attr("serializejson"))?divDom.serializeJSON():!1:(myApp.consola("SerializeJSON no instalado, recomendamos instalarlo via bower.","debug"),dataSubmit.serializeJson=!1),myApp.consola(dataSubmit,"debug");var form=divDom.parsley().validate();if(form)if(dataSubmit.backbone&&dataSubmit.model)funcion.SendBackbone(dataSubmit);else{if(!dataSubmit.ajax||!dataSubmit.action)return!0;funcion.SendAjax(dataSubmit)}return!1})},object:function(a){myApp.consola("Seleccion de objecto de dataSubmit","debug");var e=this,o=$.extend({},this.default,a);if(myApp.consola(o,"debug"),o.backbone&&o.model)e.SendBackbone(o);else{if(!o.ajax||!o.action)return!1;e.SendAjax(o)}},SendBackbone:function(a){myApp.consola("Evento canalizado a un Backbone");var e;switch(a.method){case"post":a.serializeJson?(e=new myModel[a.model](a.serializeJson),e.save({},{success:function(e,o){myApp.consola("Registro guardado en backbone","debug"),myApp.consola(o,"debug"),a.callback&&a.callback(o,a.attrs)},error:function(e,o){myApp.consola(e,"error"),myApp.consola(o,"error"),a.callbackError&&a.callbackError(o,a.attrs)}})):myApp.consola('Envio de POST sin datos, si el modelo esta definido se usaran los datos "default."',"debug");break;case"get":a.key?(e=new myModel[a.model]({id:a.key}),e.fetch({success:function(e){myApp.consola("Registro encontrado en backbone","debug"),myApp.consola(e.attributes,"debug"),a.callback&&a.callback(e.attributes,a.attrs)},error:function(e,o){myApp.consola(e,"error"),myApp.consola(o,"error"),a.callbackError&&a.callbackError(o,a.attrs)}})):myApp.consola('Envio de GET "key" requerido',"error");break;case"put":a.key?(e=new myModel[a.model]({id:a.key}),e.fetch({success:function(){myApp.consola("Registro encontrado en backbone","debug"),e.set(a.serializeJson),e.save({},{success:function(e,o){myApp.consola("Registro actualizado en backbone","debug"),myApp.consola(o,"debug"),a.callback&&a.callback(o,a.attrs)},error:function(e,o){myApp.consola(e,"error"),myApp.consola(o,"error"),a.callbackError&&a.callbackError(o,a.attrs)}})},error:function(e,o){myApp.consola(e,"error"),myApp.consola(o,"error"),a.callbackError&&a.callbackError(o,a.attrs)}})):myApp.consola('Envio de PUT "key" requerido',"error");break;case"delete":a.key?(e=new myModel[a.model]({id:a.key}),e.destroy({success:function(e,o){myApp.consola("Registro eliminado en backbone","debug"),myApp.consola(o,"debug"),a.callback&&a.callback(o,a.attrs)},error:function(e,o){myApp.consola(e,"error"),myApp.consola(o,"error"),a.callbackError&&a.callbackError(o,a.attrs)}})):myApp.consola('Envio de DELETE "key" requerido',"error")}return!1},SendAjax:function(a){myApp.consola("Evento canalizado a un ajax","debug");var e={type:a.method,url:a.action,dataType:"json"};return a.formData?(e.data=a.formData,e.processData=!1,e.contentType=!1):a.serializeJson?e.data=a.serializeJson:a.serialize&&(e.data=a.serialize),myApp.consola(e,"debug"),myApp.consola("Peticion AJAX: "+e.type,"debug"),myApp.consola("Peticion url: "+e.url,"debug"),isDefined(e.data)&&myApp.consola("Peticion parametros: "+e.data),$.ajax(e).done(function(e){myApp.consola("------Respuesta Exitosa-----","debug"),myApp.consola(e,"debug"),a.callback&&a.callback(e,a.attrs)}).fail(function(e,o){myApp.consola("Fallo en la peticion: "+o,"error"),a.callbackError&&a.callbackError(e,a.attrs)}),!1}};